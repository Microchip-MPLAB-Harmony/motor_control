<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="../../../../favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="../../../../assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2724382-16"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-2724382-16'); </script> <script type="text/javascript" src="../../../../assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="../../../../assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Implementation Details | Harmony 3 Motor Control</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="Implementation Details" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Harmony 3 Motor Control package" /> <meta property="og:description" content="Harmony 3 Motor Control package" /> <link rel="canonical" href="../../../../algorithms/pmsm_foc/mc_plant_docs/theory/software_architecture.html" /> <meta property="og:url" content="../../../../algorithms/pmsm_foc/mc_plant_docs/theory/software_architecture.html" /> <meta property="og:site_name" content="Harmony 3 Motor Control" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Implementation Details" /> <script type="application/ld+json"> {"@type":"WebPage","url":"../../../../algorithms/pmsm_foc/mc_plant_docs/theory/software_architecture.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"../../assets/images/vendor/microchip_mplab_harmony_logo_150_transparent.png"}},"headline":"Implementation Details","description":"Harmony 3 Motor Control package","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="../../../../index.html" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="../../../../index.html" class="nav-list-link">Microchip MPLAB® Harmony 3 Motor Control</a></li><li class="nav-list-item"><a href="../../../../algorithms/pmsm_foc/readme.html" class="nav-list-link">PMSM FOC Component</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../../algorithms/pmsm_foc/mc_plant_docs/introduction.html" class="nav-list-link">Motor Control Plant Projects</a><ul class="nav-list "><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../../algorithms/pmsm_foc/mc_plant_docs/theory/theoretical_background.html" class="nav-list-link">Theoretical Background</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../../algorithms/pmsm_foc/mc_plant_docs/theory/pmsm_motor.html" class="nav-list-link">Permanent Magnet Synchronous Motors</a> </li><li class="nav-list-item "> <a href="../../../../algorithms/pmsm_foc/mc_plant_docs/theory/field_oriened_control.html" class="nav-list-link">Field Oriented Control</a> </li><li class="nav-list-item "> <a href="../../../../algorithms/pmsm_foc/mc_plant_docs/theory/current_measurement.html" class="nav-list-link">Current Measurement</a> </li><li class="nav-list-item "> <a href="../../../../algorithms/pmsm_foc/mc_plant_docs/theory/rotor_position_measurement.html" class="nav-list-link">Rotor Position Calculation</a> </li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../../algorithms/pmsm_foc/mc_plant_docs/theory/software_design.html" class="nav-list-link">Software Design</a><ul class="nav-list"><li class="nav-list-item active"> <a href="../../../../algorithms/pmsm_foc/mc_plant_docs/theory/software_architecture.html" class="nav-list-link active">Implementation Details</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/getting_started.html" class="nav-list-link">Getting Started</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/create_mc_project_with_mcc.html" class="nav-list-link">Create MCC project for MC Plant</a> </li><li class="nav-list-item "> <a href="../../../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/motor_control_plant_manager.html" class="nav-list-link">MC Plant Manager</a> </li><li class="nav-list-item "> <a href="../../../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/hardware_modules.html" class="nav-list-link">Hardware Modules</a> </li><li class="nav-list-item "> <a href="../../../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/peripheral_modules.html" class="nav-list-link">Peripheral Modules</a> </li><li class="nav-list-item "> <a href="../../../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/software_modules.html" class="nav-list-link">Software Modules</a> </li><li class="nav-list-item "> <a href="../../../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/generate_mc_code_with_mcc.html" class="nav-list-link">Generate Code with MCC</a> </li></ul></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../../algorithms/pmsm_foc/non_mc_plant.html" class="nav-list-link">Non Motor Control Plant Projects</a><ul class="nav-list "><li class="nav-list-item active"><a href="../../../../algorithms/pmsm_foc/sw_design.html" class="nav-list-link">Software Design</a></li><li class="nav-list-item "><a href="../../../../algorithms/pmsm_foc/control_algorithm.html" class="nav-list-link">Control Algorithm</a></li><li class="nav-list-item "><a href="../../../../algorithms/pmsm_foc/configurations.html" class="nav-list-link">Configuring the Library</a></li><li class="nav-list-item "><a href="../../../../algorithms/pmsm_foc/using_the_library.html" class="nav-list-link">Using the Library</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../../release_notes.html" class="nav-list-link">Release notes</a><ul class="nav-list "><li class="nav-list-item "><a href="../../../../apps/readme.html" class="nav-list-link">Motor Control Application Repositories</a></li></ul></li><li class="nav-list-item"><a href="../../../../mplab_harmony_license.html" class="nav-list-link">License</a></li><li class="nav-list-item"><a href="../../../../plugins/mc_plant/intro.html" class="nav-list-link">Getting Started with Create React App</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Harmony 3 Motor Control" aria-label="Search Harmony 3 Motor Control" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://support.microchip.com" class="site-button" > Obtain Support from Microchip </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="../../../../algorithms/pmsm_foc/mc_plant_docs/introduction.html">Motor Control Plant Projects</a></li> <li class="breadcrumb-nav-list-item"><a href="../../../../algorithms/pmsm_foc/sw_design.html">Software Design</a></li> <li class="breadcrumb-nav-list-item"><span>Implementation Details</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <style> body { counter-reset: h1; padding: 20px; } h1 { background-color: red; color: white; counter-reset: h2 } h2 { background-color: red; color: white; counter-reset: h3 } h3 { background-color: red; color: white; counter-reset: h4 } h1:before { background-color: red; color: white; counter-increment: h1; content: counter(h1) ". " } h2:before { background-color: red; color: white; counter-increment: h2; content: counter(h1) "." counter(h2) ". " } h3:before { background-color: red; color: white; counter-increment: h3; content: counter(h1) "." counter(h2) "." counter(h3) ". " } h4:before { background-color: red; color: white; counter-increment: h4; content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) ". " } p{ color: black; font-family: "Arial", Helvetica, sans-serif; } article { max-width: 50em; background: white; padding: 2em; margin: 1em auto; } .table-of-contents { float: right; width: 40%; background: #eee; font-size: 0.8em; padding: 1em 2em; margin: 0 0 0.5em 0.5em; } .table-of-contents ul { padding: 0; } .table-of-contents li { margin: 0 0 0.25em 0; } .table-of-contents a { text-decoration: none; } .table-of-contents a:hover, .table-of-contents a:active { text-decoration: underline; } h3:target { animation: highlight 1s ease; } @keyframes highlight { from { background: yellow; } to { background: white; } } li{ color: black; font-family: "Arial", Helvetica, sans-serif; } table{ color: black; font-family: "Arial", Helvetica, sans-serif; } } } </style> <h1 id="field-oriented-control-implementation"> <a href="#field-oriented-control-implementation" aria-labelledby="field-oriented-control-implementation" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Field Oriented Control Implementation </h1> <p>The generated code from the Motor Control Plant intends to achieve following goals:</p> <ul> <li>to spin a motor based on simple user inputs</li> <li>to be modular and maintainable</li> <li>to be a clear example to Microchip customers for a motor control Application using Microchip’s 32 bit MCU devices</li> </ul> <p>The following section describes an overview of control software architecture to meet the above mentioned goals.</p> <h2 id="software-description-in-brief"> <a href="#software-description-in-brief" aria-labelledby="software-description-in-brief" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Software Description (In Brief) </h2> <p>The software spins a motor using a velocity control loop, with an inner current loop using field-oriented control (FOC) to manage motor current and torque. Sensorless estimation techniques are used to estimate motor position for commutation and velocity control. User input is provided with a potentiometer and buttons to start and stop the motor, or to reverse direction. A state machine is used to control the transitions between these different modes of operation.</p> <p>The motor startup process involves so-called “open-loop” operation. When the motor is at rest or moving very slowly, the sensorless estimator is not accurate enough; instead, a special set of states is provided to manage startup, in which commutation is forced at a desired acceleration rate, and the velocity control loop is disabled.</p> <p>Figure XX shows a high level block diagram of the software.</p> <h2 id="software-architecture"> <a href="#software-architecture" aria-labelledby="software-architecture" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Software Architecture </h2> <p>The software performs following tasks:</p> <ul> <li>Microcontroller and motor control peripheral initialization</li> <li>FOC State machine in ADC ISR</li> <li>Motor start and stop command by GPIO button</li> <li>Motor speed command from potentiometer</li> </ul> <h3 id="motor-control-peripheral-initialization"> <a href="#motor-control-peripheral-initialization" aria-labelledby="motor-control-peripheral-initialization" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Motor control peripheral initialization. </h3> <p>On power-on reset, the software initializes the microcontroller and motor control peripherals according to the user requirements.</p> <h3 id="motor-control-state-machine"> <a href="#motor-control-state-machine" aria-labelledby="motor-control-state-machine" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Motor control state machine </h3> <p>The software implements the motor control tasks in ADC ISR. The ADC ISR incorporates following states:</p> <ul> <li> <p><strong>Idle</strong>. In this state, the motor does not spin. The software waits for a valid button press from the user to start the motor.</p> </li> <li> <p><strong>Start-up</strong>. In this state, the software executes the PMSM start-up procedure as described in section 4.1.</p> </li> <li> <p><strong>Close-loop speed control</strong>. In this state, the software executes an SMO based sensorless FOC.</p> </li> </ul> <h3 id="motor-speed-command-from-potentiometer"> <a href="#motor-speed-command-from-potentiometer" aria-labelledby="motor-speed-command-from-potentiometer" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Motor speed command from potentiometer </h3> <p>The software calculates the speed reference from the measured from the potentiometer input.</p> <h3 id="motor-start-and-stop-command-by-gpio"> <a href="#motor-start-and-stop-command-by-gpio" aria-labelledby="motor-start-and-stop-command-by-gpio" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Motor start and stop Command by GPIO </h3> <p>The software polls the GPIO button every 10ms to check if the button has been pressed. If the button press is detected, the firmware changes the motor control state from “Idle” to “Start-up” to initiate the motor spin at the specified reference speed.</p> <p>Figure 5.2 illustrates the software flow-chart of the example project</p> <p>Figure 5.3. Software Flow Chart</p> <h2 id="modules-and-components"> <a href="#modules-and-components" aria-labelledby="modules-and-components" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Modules and Components </h2> <p>The software is based on a modular design, and consists of a number of components that work together.</p> <p>The software contains following modules:</p> <ul> <li>Hardware Abstraction: <ul> <li style="font-family:consolas;">mc_hardware_abstraction.c</li> <li style="font-family:consolas;">mc_hardware_abstraction.h</li> </ul> </li> <li>Motor control API <ul> <li style="font-family:consolas;">mc_pmsm_foc.c</li> <li style="font-family:consolas;">mc_pmsm_foc.h</li> </ul> </li> <li>Function coordination <ul> <li style="font-family:consolas;">mc_function_coordinator.c</li> <li style="font-family:consolas;">mc_function_coordinator.h</li> </ul> </li> <li>Motor control <ul> <li>State Machine <ul> <li style="font-family:consolas;">mc_motor_control.c</li> <li style="font-family:consolas;">mc_motor_control.h</li> </ul> </li> <li>Speed control <ul> <li style="font-family:consolas;">mc_speed_control.c</li> <li style="font-family:consolas;">mc_speed_control.h</li> </ul> </li> <li>Current control <ul> <li style="font-family:consolas;">mc_current_control.c</li> <li style="font-family:consolas;">mc_current_control.h</li> </ul> </li> <li>Start-up <ul> <li style="font-family:consolas;">mc_start_up.c</li> <li style="font-family:consolas;">mc_start_up.h</li> </ul> </li> <li>Phase currents <ul> <li style="font-family:consolas;">mc_current_calculation.c</li> <li style="font-family:consolas;">mc_current_calculation.h</li> </ul> </li> <li>DC bus voltage <ul> <li style="font-family:consolas;">mc_voltage_measurement.c</li> <li style="font-family:consolas;">mc_voltage_measurement.h</li> </ul> </li> <li>Rotor position <ul> <li style="font-family:consolas;">mc_rotor_position.c</li> <li style="font-family:consolas;">mc_rotor_position.h</li> </ul> </li> </ul> </li> <li>Control library <ul> <li style="font-family:consolas;">mc_generic_library.c</li> <li style="font-family:consolas;">mc_generic_library.h</li> </ul> </li> <li>Data management <ul> <li style="font-family:consolas;">mc_interface_handling.c</li> <li style="font-family:consolas;">mc_interface_handling.h</li> </ul> </li> <li>User parameters <ul> <li style="font-family:consolas;">mc_userparams.h</li> </ul> </li> </ul> <hr> <footer> <p class="text-small text-grey-dk-000 mb-0"><img src='https://raw.githubusercontent.com/wiki/Microchip-MPLAB-Harmony/Microchip-MPLAB-Harmony.github.io/images/microchip_logo.png' /><br />Copyright &copy; 2020 Microchip Technology.</p> <!-- <p class="text-small text-grey-dk-000 mb-0"><img src='../../../../assets/images/vendor/microchip_logo.png' /><br /> Copyright &copy; 2022 Microchip Technology.</p> --> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
