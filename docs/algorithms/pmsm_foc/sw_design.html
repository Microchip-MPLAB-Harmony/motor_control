<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="../../assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2724382-16"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-2724382-16'); </script> <script type="text/javascript" src="../../assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="../../assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Software Design | Harmony 3 Motor Control</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="Software Design" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Harmony 3 Motor Control package" /> <meta property="og:description" content="Harmony 3 Motor Control package" /> <link rel="canonical" href="../../algorithms/pmsm_foc/sw_design.html" /> <meta property="og:url" content="../../algorithms/pmsm_foc/sw_design.html" /> <meta property="og:site_name" content="Harmony 3 Motor Control" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Software Design" /> <script type="application/ld+json"> {"@type":"WebPage","url":"../../algorithms/pmsm_foc/sw_design.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"../../assets/images/vendor/microchip_mplab_harmony_logo_150_transparent.png"}},"headline":"Software Design","description":"Harmony 3 Motor Control package","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="../../index.html" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="../../index.html" class="nav-list-link">Microchip MPLABÂ® Harmony 3 Motor Control</a></li><li class="nav-list-item"><a href="../../algorithms/pmsm_foc/readme.html" class="nav-list-link">PMSM FOC Component</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../algorithms/pmsm_foc/mc_plant_docs/introduction.html" class="nav-list-link">Motor Control Plant Projects</a><ul class="nav-list "><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../algorithms/pmsm_foc/mc_plant_docs/theory/theoretical_background.html" class="nav-list-link">Theoretical Background</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../algorithms/pmsm_foc/mc_plant_docs/theory/pmsm_motor.html" class="nav-list-link">Permanent Magnet Synchronous Motors</a> </li><li class="nav-list-item "> <a href="../../algorithms/pmsm_foc/mc_plant_docs/theory/field_oriened_control.html" class="nav-list-link">Field Oriented Control</a> </li><li class="nav-list-item "> <a href="../../algorithms/pmsm_foc/mc_plant_docs/theory/current_measurement.html" class="nav-list-link">Current Measurement</a> </li><li class="nav-list-item "> <a href="../../algorithms/pmsm_foc/mc_plant_docs/theory/rotor_position_measurement.html" class="nav-list-link">Rotor Position Calculation</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../algorithms/pmsm_foc/mc_plant_docs/theory/software_design.html" class="nav-list-link">Software Design</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../algorithms/pmsm_foc/mc_plant_docs/theory/software_architecture.html" class="nav-list-link">Implementation Details</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/getting_started.html" class="nav-list-link">Getting Started</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/create_mc_project_with_mcc.html" class="nav-list-link">Create MCC project for MC Plant</a> </li><li class="nav-list-item "> <a href="../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/motor_control_plant_manager.html" class="nav-list-link">MC Plant Manager</a> </li><li class="nav-list-item "> <a href="../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/hardware_modules.html" class="nav-list-link">Hardware Modules</a> </li><li class="nav-list-item "> <a href="../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/peripheral_modules.html" class="nav-list-link">Peripheral Modules</a> </li><li class="nav-list-item "> <a href="../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/software_modules.html" class="nav-list-link">Software Modules</a> </li><li class="nav-list-item "> <a href="../../algorithms/pmsm_foc/mc_plant_docs/mc_plant/generate_mc_code_with_mcc.html" class="nav-list-link">Generate Code with MCC</a> </li></ul></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../algorithms/pmsm_foc/non_mc_plant.html" class="nav-list-link">Non Motor Control Plant Projects</a><ul class="nav-list "><li class="nav-list-item active"><a href="../../algorithms/pmsm_foc/sw_design.html" class="nav-list-link active">Software Design</a></li><li class="nav-list-item "><a href="../../algorithms/pmsm_foc/control_algorithm.html" class="nav-list-link">Control Algorithm</a></li><li class="nav-list-item "><a href="../../algorithms/pmsm_foc/configurations.html" class="nav-list-link">Configuring the Library</a></li><li class="nav-list-item "><a href="../../algorithms/pmsm_foc/using_the_library.html" class="nav-list-link">Using the Library</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../release_notes.html" class="nav-list-link">Release notes</a><ul class="nav-list "><li class="nav-list-item "><a href="../../apps/readme.html" class="nav-list-link">Motor Control Application Repositories</a></li></ul></li><li class="nav-list-item"><a href="../../mplab_harmony_license.html" class="nav-list-link">License</a></li><li class="nav-list-item"><a href="../../plugins/mc_plant/intro.html" class="nav-list-link">Getting Started with Create React App</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Harmony 3 Motor Control" aria-label="Search Harmony 3 Motor Control" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://support.microchip.com" class="site-button" > Obtain Support from Microchip </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="../../algorithms/pmsm_foc/non_mc_plant.html">Non Motor Control Plant Projects</a></li> <li class="breadcrumb-nav-list-item"><span>Software Design</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h2 id="software-design"> <a href="#software-design" aria-labelledby="software-design" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Software Design </h2> <h3 id="samc21-and-pic32cm-mc"> <a href="#samc21-and-pic32cm-mc" aria-labelledby="samc21-and-pic32cm-mc" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> SAMC21 and PIC32CM MC </h3> <ul> <li>PMSM FOC Control loop is implemented in the ADC result ready interrupt. Refer to the flow chart given below.</li> <li>ADC channel conversion is triggered by the PWM overflow/zero match event. This trigger point could vary based on the current measurement techniques and MCU PWM IP implementation.</li> <li>For bandwidth constraints, the FOC is executed every alternate PWM cycle</li> <li>Slow loop task is executed in every 10ms in the task process. Polling of switches for user inputs is handled in the slow loop task.</li> </ul> <h3 id="timing-diagram"> <a href="#timing-diagram" aria-labelledby="timing-diagram" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Timing Diagram </h3> <p><img src="../../algorithms/pmsm_foc/images/timing_diagram_fixed_point.jpg" alt="timing_diagram" /></p> <h3 id="flow-chart"> <a href="#flow-chart" aria-labelledby="flow-chart" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Flow Chart </h3> <p><img src="../../algorithms/pmsm_foc/images/flow_chart_fixed_point.jpg" alt="flow_chart" /></p> <h3 id="state-machine"> <a href="#state-machine" aria-labelledby="state-machine" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> State Machine </h3> <ul> <li><strong>Idle</strong>:</li> </ul> <p>In this state, control waits for the switch press.</p> <ul> <li><strong>Field Alignment</strong>:</li> </ul> <p>Rotor is aligned to known position at D-axis or Q-axis by applying a pre-defined value of the current for a pre-defined length of time. The magnitude of the current and the length of the time for which it is applied depends upon the electrical and mechanical time constant of the PMSM motor drive. Electrical time constant of the motor is a function of R and L values of the motor windings, whereas the mechanical time constant of the motor drive is primarily a function of the static load on the motor shaft.</p> <ul> <li><strong>Open Loop</strong>:</li> </ul> <p>This state is applicable to sensorless position feedback methods. In this state, the speed of the PMSM motor is gradually ramped up using an open loop control. During this mode, the rotor angle is derived from the asserted open loop speed reference. This derived rotor angle would be lagging from the actual rotor angle. The speed is ramped up linearly to a minimum value required for the PLL estimator to estimate the electrical speed of the PMSM motor with sufficient accuracy. Rotor angle information is obtained by integrating the estimated electrical speed of the motor.</p> <ul> <li><strong>Closed Loop</strong>:</li> </ul> <p>Control switched to closed loop and rotor angle is obtained from the configured position feedback method.</p> <h3 id="code-structure"> <a href="#code-structure" aria-labelledby="code-structure" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Code Structure </h3> <p><img src="../../algorithms/pmsm_foc/images/code_structure_fixed_point.jpg" alt="code_structure" /></p> <p>Configurations:</p> <ul> <li>mc_userparameters.h contains the user configurations.</li> </ul> <p>PMSM FOC Application:</p> <ul> <li>mc_pmsm_foc.c/h - PMSM FOC algorithm interface file</li> </ul> <p>Interrupts:</p> <ul> <li>mc_function_coordinator.c - Initializes and coordinates motor control ISR and slow task processes</li> <li>mc_error_handler.c - PWM fault ISR to take corrective action on over-current</li> </ul> <p>Control Middleware:</p> <ul> <li>mc_motor_control.c/h - Implements the motor control state machines.</li> </ul> <p>Control library:</p> <ul> <li>mc_start_up.c/h - Implements the initial field alignment and open loop start-up profile.</li> <li>mc_speed_control.c/h - Calculate and regulates the reference speed</li> <li>mc_current_control.c/h - Controls the direct and quadrature axis currents</li> <li>mc_rotor_position.c/.h - Calculate the position and speed of the rotor</li> <li>mc_voltage_measurement.c/h - Get the DC Bus voltage</li> <li>mc_current_measurement.c/h - Get the motor phase currents</li> <li>mc_interface_handling.c/h - Manages global variables and data-types</li> <li>mc_generic_library.c/h - FOC library</li> <li>mc_pwm.c/h - Space Vector modulation (SVM) and updating PWM duty cycles</li> <li>mc_ramp_profiler.c/h - Speed reference profiles for user inputs</li> </ul> <p>HAL:</p> <ul> <li>mc_hardware_abstraction.c/h - Hardware Abstraction Layer to interact with PLIBs</li> </ul> <hr> <footer> <p class="text-small text-grey-dk-000 mb-0"><img src='https://raw.githubusercontent.com/wiki/Microchip-MPLAB-Harmony/Microchip-MPLAB-Harmony.github.io/images/microchip_logo.png' /><br />Copyright &copy; 2020 Microchip Technology.</p> <!-- <p class="text-small text-grey-dk-000 mb-0"><img src='../../assets/images/vendor/microchip_logo.png' /><br /> Copyright &copy; 2022 Microchip Technology.</p> --> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
