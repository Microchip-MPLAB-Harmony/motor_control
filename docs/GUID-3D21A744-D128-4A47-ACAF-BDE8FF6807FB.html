<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2022" />
<meta name="DC.rights.owner" content="(C) Copyright 2022" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="Field Oriented Control Implementation" />
<meta name="DC.relation" scheme="URI" content="GUID-F2F0CF32-A3D4-4989-AC0F-6B8213BFD997.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="field-oriented-control-implementation" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<title>Field Oriented Control Implementation</title>
<meta name="Microsoft.Help.Id" content="GUID-0A4BC4EE-29F5-4736-8125-17139B84E7B5-field-oriented-control-implementation" />
<meta name="Microsoft.Help.TocParent" content="GUID-0A4BC4EE-29F5-4736-8125-17139B84E7B5" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLAB® Harmony 3 Motor Control Reference A 12/2021" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
         
         function copyContent(content, button) {
         
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                     button.textContent = "Copy";
                     button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
               console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
         }
         
         function cpy(id, button) {
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            
            copyContent(content, button);
         }
         
         document.addEventListener("DOMContentLoaded", function(event) {
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.style.position = "relative";
               var copy = document.createElement("button");
               copy.textContent = "Copy";
               copy.setAttribute("class", "copy-code");
               
               var content = elem.textContent;
               
               copy.addEventListener("click", function(){
                  copyContent(content, copy);
               });
               
               elem.addEventListener("mouseenter", function(evt){
                  elem.prepend(copy);
               });
            });
            
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.addEventListener("mouseleave", function(evt){
                  document.querySelector(".copy-code").remove();
               });
            });
         });
         
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-3D21A744-D128-4A47-ACAF-BDE8FF6807FB"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /></head>
<body id="field-oriented-control-implementation">
<h1 class="title topictitle1" id="ariaid-title1">Field Oriented Control Implementation</h1><div class="body"><p class="p">The generated code from the Motor Control Plant intends to achieve following goals:</p>
<ul class="ul"><li class="li"><p class="p">to spin a motor based on simple user inputs</p>
</li>
<li class="li"><p class="p">to be modular and maintainable</p>
</li>
<li class="li"><p class="p">to be a clear example to Microchip customers for a motor control Application using Microchip's 32 bit MCU devices</p>
</li>
</ul>
<p class="p">The following section describes an overview of control software architecture to meet the above mentioned goals.</p>
<p class="p">** Software Description (In Brief)**
The software spins a motor using a velocity control loop, with an inner current loop using field-oriented control (FOC) to manage motor current and torque. Sensorless estimation techniques are used to estimate motor position for commutation and velocity control. User input is provided with a potentiometer and buttons to start and stop the motor, or to reverse direction. A state machine is used to control the transitions between these different modes of operation.</p>
<p class="p">The motor startup process involves so-called “open-loop” operation. When the motor is at rest or moving very slowly, the sensorless estimator is not accurate enough; instead, a special set of states is provided to manage startup, in which commutation is forced at a desired acceleration rate, and the velocity control loop is disabled.</p>
<p class="p">Figure XX shows a high level block diagram of the software.</p>
<p class="p">** Software Architecture**</p>
<p class="p">The software performs following tasks:</p>
<ul class="ul"><li class="li"><p class="p">Microcontroller and motor control peripheral initialization</p>
</li>
<li class="li"><p class="p">FOC State machine in ADC ISR</p>
</li>
<li class="li"><p class="p">Motor start and stop command by GPIO button</p>
</li>
<li class="li"><p class="p">Motor speed command from potentiometer</p>
</li>
</ul>
<p class="p"><strong class="ph b">Motor control peripheral initialization.</strong></p>
<p class="p">On power-on reset, the software initializes the microcontroller and motor control peripherals according to the user requirements.</p>
<p class="p">** Motor control state machine**
The software implements the motor control tasks in ADC ISR. The ADC ISR incorporates following states:</p>
<ul class="ul"><li class="li"><p class="p"><strong class="ph b">Idle</strong>. In this state, the motor does not spin. The software waits for a valid button press from the user to start the motor.</p>
</li>
<li class="li"><p class="p"><strong class="ph b">Start-up</strong>. In this state, the software executes the PMSM start-up procedure as described in section 4.1.</p>
</li>
<li class="li"><p class="p"><strong class="ph b">Close-loop speed control</strong>. In this state, the software executes an SMO based sensorless FOC.</p>
</li>
</ul>
<p class="p"><strong class="ph b">Motor speed command from potentiometer</strong>
The software calculates the speed reference from the measured from the potentiometer input.</p>
<p class="p"><strong class="ph b">Motor start and stop Command by GPIO</strong>
The software polls the GPIO button every 10ms to check if the button has been pressed. If the button press is detected, the firmware changes the motor control state from “Idle” to “Start-up” to initiate the motor spin at the specified reference speed.</p>
<p class="p">Figure 5.2 illustrates the software flow-chart of the example project</p>
<p class="p">Figure 5.3. Software Flow Chart</p>
<p class="p"><strong class="ph b">Modules and Components</strong>
The software is based on a modular design, and consists of a number of components that work together.</p>
<p class="p">The software contains following modules:</p>
<ul class="ul"><li class="li"><p class="p">Hardware Abstraction:</p>
<ul class="ul">
        <li class="li">mc_hardware_abstraction.c</li>

        <li class="li">mc_hardware_abstraction.h</li>

    </ul>
</li>
<li class="li"><p class="p">Motor control API</p>
<ul class="ul">
        <li class="li">mc_pmsm_foc.c</li>

        <li class="li">mc_pmsm_foc.h</li>

    </ul>
</li>
<li class="li"><p class="p">Function coordination</p>
<ul class="ul">
        <li class="li">mc_function_coordinator.c</li>

        <li class="li">mc_function_coordinator.h</li>

    </ul>
</li>
<li class="li"><p class="p">Motor control</p>
<ul class="ul"><li class="li"><p class="p">State Machine</p>
<ul class="ul">
            <li class="li">mc_motor_control.c</li>

            <li class="li">mc_motor_control.h</li>

        </ul>
</li>
<li class="li"><p class="p">Speed control</p>
<ul class="ul">
            <li class="li">mc_speed_control.c</li>

            <li class="li">mc_speed_control.h</li>

        </ul>
</li>
<li class="li"><p class="p">Current control</p>
<ul class="ul">
            <li class="li">mc_current_control.c</li>

            <li class="li">mc_current_control.h</li>

        </ul>
</li>
<li class="li"><p class="p">Start-up</p>
<ul class="ul">
            <li class="li">mc_start_up.c</li>

            <li class="li">mc_start_up.h</li>

        </ul>
</li>
<li class="li"><p class="p">Phase currents</p>
<ul class="ul">
            <li class="li">mc_current_calculation.c</li>

            <li class="li">mc_current_calculation.h</li>

        </ul>
</li>
<li class="li"><p class="p">DC bus voltage</p>
<ul class="ul">
            <li class="li">mc_voltage_measurement.c</li>

            <li class="li">mc_voltage_measurement.h</li>

        </ul>
</li>
<li class="li"><p class="p">Rotor position</p>
<ul class="ul">
            <li class="li">mc_rotor_position.c</li>

            <li class="li">mc_rotor_position.h</li>

        </ul>
</li>
</ul>
</li>
<li class="li"><p class="p">Control library</p>
<ul class="ul">
        <li class="li">mc_generic_library.c</li>

        <li class="li">mc_generic_library.h</li>

    </ul>
</li>
<li class="li"><p class="p">Data management</p>
<ul class="ul">
        <li class="li">mc_interface_handling.c</li>

        <li class="li">mc_interface_handling.h</li>

    </ul>
</li>
<li class="li"><p class="p">User parameters</p>
<ul class="ul">
        <li class="li">mc_userparams.h</li>

    </ul>
</li>
</ul>
</div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-F2F0CF32-A3D4-4989-AC0F-6B8213BFD997.html">Software Design</a></div>
</div>
</div></body>
</html>